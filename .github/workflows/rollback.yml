name: Publish

on:
  push:
    branches:
      - rollback-branch

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Tag
        id: autotagger
        uses: butlerlogic/action-autotag@stable
        with:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
      
      - name: Release
        id: create_release
        if: steps.autotagger.outputs.tagname != ''
        uses: actions/create-release@v1.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.autotagger.outputs.tagname }}
          release_name: Version ${{ steps.autotagger.outputs.version }}
          body: ${{ steps.autotagger.outputs.tagmessage }}
          draft: false
          prerelease: true

      - name: Publish
        id: publish_npm
        if: steps.autotagger.outputs.tagname != ''
        uses: author/action-publish@stable
        env:
          REGISTRY_TOKEN: ${{ secrets.REGISTRY_TOKEN }}

      - name: Rollback Release
        if: failure() && steps.create_release.outputs.id != ''
        uses: author/action-rollback@stable
        with:
          # Using a known release ID
          id: ${{ steps.create_release.id }}
          # Using a tag name
          tag: ${{ steps.autotagger.outputs.tagname }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}




# name: Rollback Deployment

# on:
#   push:
#     branches: ["rollback-branch"]
#     paths: [".github/workflows/first-action.yml"]

# jobs:
#   rollback:
#     runs-on: ubuntu-latest

#     steps:
#     - name: Checkout Repository
#       uses: actions/checkout@v2

#     - name: Get Previous Deployment
#       id: get_deployment
#       run: |
#         PREVIOUS_DEPLOYMENT=$(curl -X GET \
#           -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
#           -H "Accept: application/vnd.github.ant-man-preview+json" \
#           "https://api.github.com/repos/${{ github.repository }}/deployments?environment=production&per_page=1")
#         echo "::set-output name=previous_deployment::$(echo $PREVIOUS_DEPLOYMENT | jq -r '.[0].id')"
#       env:
#         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

#     - name: Rollback Deployment
#       run: |
#         PREVIOUS_DEPLOYMENT_ID="${{ steps.get_deployment.outputs.previous_deployment }}"
#         curl -X POST \
#           -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
#           -H "Accept: application/vnd.github.ant-man-preview+json" \
#           "https://api.github.com/repos/${{ github.repository }}/deployments/${PREVIOUS_DEPLOYMENT_ID}/statuses" \
#           -d "{\"state\":\"success\",\"environment\":\"production\"}"
#       env:
#         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}



# # name: Rollback Deployment

# # on:
# #   push:
# #     branches: ["rollback-branch"]
# #     paths: [".github/workflows/first-action.yml"]
  
# #   # workflow_run:
# #   #   workflows: ["Deploy"]
# #   #   types:  [requested]
# #   #   branches:
# #   #     - 'rollback-branch'

# # jobs:
# #   rollback:
# #     runs-on: ubuntu-latest

# #     steps:

# #     - name: Create Rollback Deployment
# #       id: rollback-deployment
# #       env:
# #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
# #       run: |
# #         ROLLBACK_DEPLOYMENT=$(curl -s -X POST \
# #           -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
# #           -H "Accept: application/vnd.github.v3+json" \ https://api.github.com/repos/:owner/:repo/deployments \
# #           -d '{ "ref": "c37070ba45a3409e9a7ed6eeaa4bd35dd3e74454"}')
